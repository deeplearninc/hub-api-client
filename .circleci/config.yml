version: 2.1
jobs:
  test-2:
    docker:
      - image: circleci/python:2.7.15
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            pip install -r requirements.txt --user
      - run:
          name: run tests
          command: |
            python $HOME/.local/lib/python2.7/site-packages/nose2
      - store_artifacts:
          path: test-reports
          destination: test-reports

  test:
    parameters:
      python_version:
        default: "3.7"
        type: string
    docker:
      - image: circleci/python:<< parameters.python_version >>
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python<< parameters.python_version >>/site-packages
      - restore_cache:
          keys:
            - dependencies-{{ arch }}-<< parameters.python_version >>-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
            - dependencies-{{ arch }}-<< parameters.python_version >>-{{ .Branch }}
            - dependencies-{{ arch }}-<< parameters.python_version >>
      - run:
          command: |
            sudo pip install pipenv
            pipenv install --dev
      - save_cache:
          key: dependencies-{{ arch }}-<< parameters.python_version >>-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
          paths:
            - ".venv"
            - "/usr/local/bin"
            - "/usr/local/lib/python<< parameters.python_version >>/site-packages"
      - run: pipenv run python setup.py test
      - store_artifacts:
          path: test-reports
          destination: test-reports

  build_and_release:
    parameters:
      python_version:
        default: "3.7"
        type: string
    working_directory: ~/repo
    docker:
      - image: circleci/python:3.7
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python3.7/site-packages
      - restore_cache:
          keys:
            - dependencies-{{ arch }}-<< parameters.python_version >>-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
            - dependencies-{{ arch }}-<< parameters.python_version >>-{{ .Branch }}
            - dependencies-{{ arch }}-<< parameters.python_version >>
      - run:
          command: |
            sudo pip install pipenv
            pipenv install
      - run: pipenv run python setup.py verify
      - run:
          command: |
            echo -e "[pypi]" >> ~/.pypirc
            echo -e "username = $PYPI_USERNAME" >> ~/.pypirc
            echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
      - run: pipenv run python setup.py bdist_wheel
      - run:
          command: |
            sudo pip install twine
            echo "Deploying new package to pypi.org..."
            twine upload dist/*
workflows:
  version: 2.1
  test_build_release:
    jobs:
      - test-2:
          name: test-2
          # For all branches and all tags https://circleci.com/docs/2.0/workflows/#executing-workflows-for-a-git-tag
          filters:
            tags:
              only: /.*/
      - test:
          name: test-3.6
          python_version: "3.6"
          filters:
            tags:
              only: /.*/
      - test:
          name: test-3.7
          python_version: "3.7"
          filters:
            tags:
              only: /.*/
      - build_and_release:
          python_version: "3.7"
          requires:
            - test-2
            - test-3.6
            - test-3.7
          # Only for v tags
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
